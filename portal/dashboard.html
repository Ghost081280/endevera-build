<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Endevera Member Portal</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='5' y='5' width='90' height='90' fill='none' stroke='%23c9a227' stroke-width='6'/><text x='50' y='68' font-family='Georgia,serif' font-size='55' font-weight='500' fill='%23c9a227' text-anchor='middle'>E</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/shared-styles.css">
    <style>
        /* Portal-specific styles */
        .portal-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 20px 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--color-medium-gray);
        }

        .portal-nav-left {
            display: flex;
            align-items: center;
            gap: 60px;
        }

        .portal-logo {
            font-family: var(--font-sans);
            font-weight: 300;
            font-size: 22px;
            letter-spacing: 8px;
            text-transform: uppercase;
            color: var(--color-white);
            text-decoration: none;
            border-left: 3px solid var(--color-gold);
            padding-left: 16px;
            transition: var(--transition-fast);
        }

        .portal-logo:hover {
            color: var(--color-gold);
        }

        .portal-nav-links {
            display: flex;
            gap: 40px;
            list-style: none;
        }

        .portal-nav-links a {
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--color-white);
            text-decoration: none;
            position: relative;
            padding: 8px 0;
            transition: var(--transition-fast);
        }

        .portal-nav-links a.active {
            color: var(--color-gold);
        }

        .portal-nav-links a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 1px;
            background: var(--color-gold);
            transition: var(--transition-smooth);
        }

        .portal-nav-links a:hover::after,
        .portal-nav-links a.active::after {
            width: 100%;
        }

        .portal-nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .portal-user-info {
            font-size: 13px;
            color: var(--color-light-gray);
        }

        .portal-user-name {
            color: var(--color-white);
            font-weight: 500;
        }

        .portal-logout {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--color-white);
            background: transparent;
            padding: 12px 24px;
            text-decoration: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: var(--transition-smooth);
        }

        .portal-logout:hover {
            border-color: var(--color-gold);
            color: var(--color-gold);
        }

        .portal-content {
            min-height: 100vh;
            padding: 120px 60px 80px;
            background: var(--color-black);
        }

        .portal-header {
            max-width: 1400px;
            margin: 0 auto 60px;
        }

        .portal-title {
            font-family: var(--font-serif);
            font-size: 48px;
            font-weight: 300;
            color: var(--color-white);
            margin-bottom: 10px;
        }

        .portal-subtitle {
            font-size: 16px;
            color: var(--color-light-gray);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
            max-width: 1400px;
            margin: 0 auto 60px;
        }

        .stat-card {
            background: var(--color-dark-gray);
            border: 1px solid var(--color-medium-gray);
            padding: 30px;
            transition: var(--transition-smooth);
        }

        .stat-card:hover {
            border-color: var(--color-gold);
            transform: translateY(-5px);
        }

        .stat-card-label {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--color-light-gray);
            margin-bottom: 15px;
        }

        .stat-card-value {
            font-family: var(--font-serif);
            font-size: 42px;
            font-weight: 300;
            color: var(--color-gold);
            line-height: 1;
        }

        .stat-card-change {
            font-size: 13px;
            color: var(--color-light-gray);
            margin-top: 10px;
        }

        .deals-section {
            max-width: 1400px;
            margin: 0 auto 60px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-title {
            font-family: var(--font-serif);
            font-size: 32px;
            font-weight: 400;
            color: var(--color-white);
        }

        .deals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
        }

        .deal-card {
            background: var(--color-dark-gray);
            border: 1px solid var(--color-medium-gray);
            overflow: hidden;
            transition: var(--transition-smooth);
            cursor: pointer;
        }

        .deal-card:hover {
            border-color: var(--color-gold);
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        .deal-card-image {
            width: 100%;
            height: 200px;
            background: var(--color-medium-gray);
            background-size: cover;
            background-position: center;
        }

        .deal-card-content {
            padding: 30px;
        }

        .deal-card-category {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--color-gold);
            margin-bottom: 10px;
        }

        .deal-card-title {
            font-family: var(--font-serif);
            font-size: 24px;
            font-weight: 400;
            color: var(--color-white);
            margin-bottom: 15px;
        }

        .deal-card-description {
            font-size: 14px;
            color: var(--color-light-gray);
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .deal-card-meta {
            display: flex;
            justify-content: space-between;
            padding-top: 20px;
            border-top: 1px solid var(--color-medium-gray);
        }

        .deal-card-meta-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .deal-card-meta-label {
            font-size: 10px;
            font-weight: 500;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            color: var(--color-light-gray);
        }

        .deal-card-meta-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--color-white);
        }

        .reports-section {
            max-width: 1400px;
            margin: 0 auto;
        }

        .reports-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .report-card {
            background: var(--color-dark-gray);
            border: 1px solid var(--color-medium-gray);
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition-smooth);
            cursor: pointer;
        }

        .report-card:hover {
            border-color: var(--color-gold);
        }

        .report-card-info {
            flex: 1;
        }

        .report-card-type {
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--color-gold);
            margin-bottom: 10px;
        }

        .report-card-title {
            font-size: 20px;
            font-weight: 500;
            color: var(--color-white);
            margin-bottom: 10px;
        }

        .report-card-date {
            font-size: 13px;
            color: var(--color-light-gray);
        }

        .report-card-action {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--color-gold);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .report-card-action svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            stroke-width: 2;
            fill: none;
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            opacity: 0.3;
        }

        .empty-state-icon svg {
            width: 100%;
            height: 100%;
            stroke: var(--color-light-gray);
            stroke-width: 1;
            fill: none;
        }

        .empty-state-title {
            font-size: 20px;
            color: var(--color-white);
            margin-bottom: 10px;
        }

        .empty-state-text {
            font-size: 15px;
            color: var(--color-light-gray);
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--color-medium-gray);
            border-top-color: var(--color-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .deals-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            .portal-nav {
                padding: 20px 30px;
            }

            .portal-nav-links {
                display: none;
            }

            .portal-content {
                padding: 100px 30px 60px;
            }
        }

        @media (max-width: 768px) {
            .dashboard-grid,
            .deals-grid {
                grid-template-columns: 1fr;
            }

            .portal-title {
                font-size: 36px;
            }

            .deal-card-meta {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body data-page-type="portal">

    <!-- Portal Navigation -->
    <nav class="portal-nav">
        <div class="portal-nav-left">
            <a href="../index.html" class="portal-logo">ENDEVERA</a>
            <ul class="portal-nav-links">
                <li><a href="dashboard.html" class="active">Dashboard</a></li>
                <li><a href="deals.html">Opportunities</a></li>
                <li><a href="reports.html">Reports</a></li>
                <li><a href="profile.html">Account</a></li>
            </ul>
        </div>
        <div class="portal-nav-right">
            <div class="portal-user-info">
                Welcome, <span class="portal-user-name" id="userName">Member</span>
            </div>
            <button class="portal-logout" id="logoutBtn">Logout</button>
        </div>
    </nav>

    <!-- Portal Content -->
    <div class="portal-content">
        <!-- Header -->
        <div class="portal-header">
            <h1 class="portal-title">Dashboard</h1>
            <p class="portal-subtitle">Welcome to your investment portal</p>
        </div>

        <!-- Stats Grid -->
        <div class="dashboard-grid" id="statsGrid">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Active Deals Section -->
        <div class="deals-section">
            <div class="section-header">
                <h2 class="section-title">Active Opportunities</h2>
                <a href="deals.html" class="btn-secondary">View All</a>
            </div>
            <div class="deals-grid" id="dealsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Recent Reports Section -->
        <div class="reports-section">
            <div class="section-header">
                <h2 class="section-title">Recent Reports</h2>
                <a href="reports.html" class="btn-secondary">View All</a>
            </div>
            <div class="reports-list" id="reportsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="../js/shared-script.js"></script>
    <!-- Note: Component loader not needed for portal - nav is inline -->
    
    <!-- Page-specific JavaScript -->
    <script>
        // Authentication Check
        const authToken = localStorage.getItem('authToken');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        if (!authToken) {
            window.location.href = '../login.html';
        }

        // Display user name
        if (user.firstName) {
            document.getElementById('userName').textContent = user.firstName;
        }

        // Logout Handler
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = '../login.html';
        });

        // Fetch Dashboard Data
        async function loadDashboard() {
            try {
                const response = await fetch('/api/portal/dashboard', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderStats(data.dashboard);
                } else if (response.status === 401) {
                    // Token expired
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('user');
                    window.location.href = '../login.html';
                } else {
                    console.error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }

        // Render Stats
        function renderStats(dashboard) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-label">Active Deals</div>
                    <div class="stat-card-value">${dashboard.activeDeals || 0}</div>
                    <div class="stat-card-change">Available for investment</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Recent Reports</div>
                    <div class="stat-card-value">${dashboard.recentReports || 0}</div>
                    <div class="stat-card-change">Last 30 days</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Member Since</div>
                    <div class="stat-card-value">${new Date(dashboard.memberSince).getFullYear()}</div>
                    <div class="stat-card-change">${formatDate(dashboard.memberSince)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Last Login</div>
                    <div class="stat-card-value">${formatTime(dashboard.lastLogin)}</div>
                    <div class="stat-card-change">${formatDate(dashboard.lastLogin)}</div>
                </div>
            `;
        }

        // Fetch Active Deals
        async function loadDeals() {
            try {
                const response = await fetch('/api/portal/deals', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderDeals(data.deals.slice(0, 3)); // Show first 3
                } else {
                    document.getElementById('dealsGrid').innerHTML = '<div class="empty-state"><p class="empty-state-text">Unable to load opportunities</p></div>';
                }
            } catch (error) {
                console.error('Deals error:', error);
                document.getElementById('dealsGrid').innerHTML = '<div class="empty-state"><p class="empty-state-text">Unable to load opportunities</p></div>';
            }
        }

        // Render Deals
        function renderDeals(deals) {
            const dealsGrid = document.getElementById('dealsGrid');
            
            if (deals.length === 0) {
                dealsGrid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                        </div>
                        <h3 class="empty-state-title">No Active Opportunities</h3>
                        <p class="empty-state-text">Check back soon for new investment opportunities</p>
                    </div>
                `;
                return;
            }

            dealsGrid.innerHTML = deals.map(deal => `
                <div class="deal-card" onclick="window.location.href='deals.html?id=${deal.id}'">
                    <div class="deal-card-image" style="background-image: url('${deal.images?.[0] || 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&q=80'}')"></div>
                    <div class="deal-card-content">
                        <div class="deal-card-category">${deal.category || 'Infrastructure'}</div>
                        <h3 class="deal-card-title">${deal.title}</h3>
                        <p class="deal-card-description">${truncate(deal.description, 100)}</p>
                        <div class="deal-card-meta">
                            <div class="deal-card-meta-item">
                                <span class="deal-card-meta-label">Target</span>
                                <span class="deal-card-meta-value">$${formatMoney(deal.target_amount)}</span>
                            </div>
                            <div class="deal-card-meta-item">
                                <span class="deal-card-meta-label">Minimum</span>
                                <span class="deal-card-meta-value">$${formatMoney(deal.minimum_investment)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Fetch Recent Reports
        async function loadReports() {
            try {
                const response = await fetch('/api/portal/reports', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderReports(data.reports.slice(0, 3)); // Show first 3
                } else {
                    document.getElementById('reportsList').innerHTML = '<div class="empty-state"><p class="empty-state-text">Unable to load reports</p></div>';
                }
            } catch (error) {
                console.error('Reports error:', error);
                document.getElementById('reportsList').innerHTML = '<div class="empty-state"><p class="empty-state-text">Unable to load reports</p></div>';
            }
        }

        // Render Reports
        function renderReports(reports) {
            const reportsList = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                reportsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        </div>
                        <h3 class="empty-state-title">No Reports Available</h3>
                        <p class="empty-state-text">New reports will appear here</p>
                    </div>
                `;
                return;
            }

            reportsList.innerHTML = reports.map(report => `
                <div class="report-card">
                    <div class="report-card-info">
                        <div class="report-card-type">${report.type}</div>
                        <h3 class="report-card-title">${report.title}</h3>
                        <p class="report-card-date">Published ${formatDate(report.published_at)}</p>
                    </div>
                    <a href="${report.file_url || '#'}" class="report-card-action">
                        View Report
                        <svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </a>
                </div>
            `).join('');
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }

        function formatMoney(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(0) + 'K';
            }
            return amount.toLocaleString();
        }

        function truncate(text, length) {
            if (text.length <= length) return text;
            return text.substring(0, length) + '...';
        }

        // Initialize Dashboard
        loadDashboard();
        loadDeals();
        loadReports();
    </script>
</body>
</html>
